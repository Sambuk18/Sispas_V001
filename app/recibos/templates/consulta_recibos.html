{% extends "base.html" %}

{% block title %}Consulta de Recibos{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Consultar Recibos</h2>
        <form method="POST" action="{{ url_for('dbf_sync.sincronizar_datos') }}" onsubmit="mostrarCarga()">
            <button type="submit" class="btn btn-warning btn-sm">
                <i class="fas fa-sync-alt"></i> Actualizar Datos
            </button>
        </form>
    </div>

    <div id="progresoCarga" style="display:none; margin-top: 15px;">
        <div class="alert alert-info">
            <strong>Procesando...</strong> Por favor espera mientras se sincronizan los datos.
        </div>
        <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                role="progressbar" style="width: 100%"></div>
        </div>
    </div>

    <form method="GET" class="mb-4">
        <div class="row g-3">
            <!-- Filtro por fecha específica -->
            <div class="col-md-3">
                <label for="fecha">Fecha específica:</label>
                <input type="date" id="fecha" name="fecha" class="form-control" 
                       value="{{ fecha }}" onchange="document.getElementById('fecha_desde').value=''; document.getElementById('fecha_hasta').value=''">
            </div>
            
            <!-- Filtro por rango de fechas -->
            <div class="col-md-3">
                <label for="fecha_desde">Desde:</label>
                <input type="date" id="fecha_desde" name="fecha_desde" class="form-control" 
                       value="{{ fecha_desde }}" onchange="document.getElementById('fecha').value=''">
            </div>
            <div class="col-md-3">
                <label for="fecha_hasta">Hasta:</label>
                <input type="date" id="fecha_hasta" name="fecha_hasta" class="form-control" 
                       value="{{ fecha_hasta }}" onchange="document.getElementById('fecha').value=''">
            </div>
            
            <!-- Filtro por productor -->
            <div class="col-md-3">
                <label for="productor_id">Productor:</label>
                <select id="productor_id" name="productor_id" class="form-select">
                    <option value="todos">Todos los productores</option>
                    {% for p in productores %}
                    <option value="{{ p.id }}" {% if productor_id == p.id|string %}selected{% endif %}>
                        {{ p.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Botones -->
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">Filtrar</button>
                <a href="{{ url_for('recibos.list_recibos') }}" class="btn btn-secondary">Limpiar</button>
            </div>
        </div>
    </form>
    {% if recibos %}
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-sm">
                <thead class="thead-dark">
                    <tr>
                        <th>Recibo</th>
                        <th>Fecha</th>
                        <th>Productor</th>
                        <th>Cliente</th>
                        <th>Dominio</th>
                        <th>Vehículo</th>
                        <th>Monto</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for recibo in recibos %}
                    <tr>
                        <td>{{ recibo.recibo_completo }}</td>
                        <td>{{ recibo.fec_ope }}</td>
                        <td>{{ recibo.nombre_productor }}</td>
                        <td>{{ recibo.des_gasto }}</td>
                        <td>{{ recibo.pat_ent }}</td>
                        <td>{{ recibo.mar_ca }} {{ recibo.ano_mod }}</td>
                        <td>{{ "$ %.2f"|format(recibo.premio|float) }}</td>
                        <td>
                            <!-- Botón PDF simple -->
                            <form action="{{ url_for('recibos.generar_pdf') }}" method="POST" target="_blank" class="d-inline">
                                {% for clave, valor in recibo.items() %}
                                    <input type="hidden" name="{{ clave }}" value="{{ valor }}">
                                {% endfor %}
                                <button type="submit" class="btn btn-sm btn-success">PDF</button>
                            </form>

                            <!-- Botón PDF con deuda -->
                            <form action="{{ url_for('recibos.generar_pdf_debe') }}" method="POST" target="_blank" class="d-inline">
                                {% for clave, valor in recibo.items() %}
                                    <input type="hidden" name="{{ clave }}" value="{{ valor }}">
                                {% endfor %}
                                <button type="submit" class="btn btn-sm btn-outline-warning">Debe</button>
                            </form>

                            <!-- Botón enviar por mail -->
                            <form action="{{ url_for('recibos.enviar_pdf') }}" method="POST" class="d-inline">
                                {% for clave, valor in recibo.items() %}
                                    <input type="hidden" name="{{ clave }}" value="{{ valor }}">
                                {% endfor %}
                                <button type="submit" class="btn btn-sm btn-outline-primary">Mail</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Paginación -->
        {% if pagination.pages > 1 %}
        <nav aria-label="Page navigation">
            <ul class="pagination">
                {% if pagination.page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('recibos.list_recibos', 
                        page=pagination.page-1,
                        fecha=fecha,
                        fecha_desde=fecha_desde,
                        fecha_hasta=fecha_hasta,
                        productor_id=productor_id) }}">
                        &laquo; Anterior
                    </a>
                </li>
                {% endif %}
                
                {% for page_num in range(1, pagination.pages + 1) %}
                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('recibos.list_recibos', 
                            page=page_num,
                            fecha=fecha,
                            fecha_desde=fecha_desde,
                            fecha_hasta=fecha_hasta,
                            productor_id=productor_id) }}">
                            {{ page_num }}
                        </a>
                    </li>
                {% endfor %}
                
                {% if pagination.page < pagination.pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('recibos.list_recibos', 
                        page=pagination.page+1,
                        fecha=fecha,
                        fecha_desde=fecha_desde,
                        fecha_hasta=fecha_hasta,
                        productor_id=productor_id) }}">
                        Siguiente &raquo;
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    {% elif fecha or fecha_desde or fecha_hasta or productor_filter or recibo_filter %}
        <p class="text-danger">No se encontraron recibos con los filtros proporcionados.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function mostrarCarga() {
    document.getElementById("progresoCarga").style.display = "block";
}
</script>
{% endblock %}